<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <title>Blocky JSON :</title>
        <script src="blocky/blockly_compressed.js"></script>
        <script src="blocky/blocks_compressed.js"></script>
        <script src="blocky/msg/js/fr.js"></script>
        <script>
            Blockly.Blocks['triple_equal'] = {
                init: function(){
                    this.appendStatementInput('===')
                        .appendField('===');
                }
            };

            Blockly.Blocks['function'] = {
                init: function(){
                    this.setNextStatement(true);
                    this.setPreviousStatement(true);

                    this.appendDummyInput()
                        .appendField(
                            new Blockly.FieldTextInput('Nom variable'),
                            'var'
                        );

                    this.appendStatementInput('Values')
                        .appendField('valeurs');
                }
            };

            Blockly.Blocks['arguments'] = {
                init: function(){
                    this.setNextStatement(true);
                    this.setPreviousStatement(true);

                    this.appendDummyInput()
                        .appendField(
                            new Blockly.FieldTextInput('Arguments'),
                            'arguments'
                        );
                }
            };
        </script>
    </head>
    <body>
        <main id="Blocky" style="height: 480px; width: 600px;">
            <xml id="toolbox" style="display: none">
                <block type="triple_equal"></block>
                <block type="function"></block>
                <block type="arguments"></block>
            </xml>
        </main>
        <footer>

        </footer>
        <script>
            let workSpace = Blockly.inject('Blocky', {
                toolbox: document.body.children[0].children[0]
            });

            class Block{
                constructor(){
                    this._parentIdentifiant = "";
                    this._valeurName = "";
                    this._identifiant = "";
                    this._nextIdentifiant = "";
                }
            }

            workSpace.addChangeListener((event) => {
                let blocks = [];
                workSpace.getAllBlocks().forEach((value) => {
                    let blockTemps = new Block();
                    blockTemps._parentIdentifiant = (value.parentBlock_ != null) ? value.parentBlock_.id : "null";
                    blockTemps._identifiant = value.id;
                    blockTemps._valeurName = value.inputList[0].fieldRow[0].value_;
                    blockTemps._nextIdentifiant = ((value.nextConnection != null)&&(value.nextConnection.targetConnection != null)) ? value.nextConnection.targetConnection.sourceBlock_.id : "null";
                    blocks.push(blockTemps);
                });
                console.log(blocks);

                let nexts = [];
                blocks.forEach((value, index, array) => {
                    if(value._nextIdentifiant != "null"){
                        nexts.push([value._nextIdentifiant, value._identifiant]);
                    }
                });
                console.log(nexts);

                let ends = [];
                blocks.forEach((value, index, array) => {
                    if((value._nextIdentifiant === "null")&&(index != 0)){
                        ends.push(value._identifiant);
                    }
                });
                console.log(ends);

                let returnIdentifiants = (identifiant, list) => {
                    let result = new Block();
                    list.forEach((value, index, array) => {
                        if(identifiant === value._identifiant){
                            result = value;
                        }
                    });
                    return result;
                };

                let returnTable = (node, nodePrecedent) => {
                    let tmp;
                    if(node._identifiant != "null"){
                        tmp = returnTable(nodePrecedent, returnIdentifiants(nodePrecedent._parentIdentifiant, blocks));
                        if(nodePrecedent._nextIdentifiant === node._identifiant){
                            tmp.unshift(ends[0]._identifiant);
                        }else{
                            tmp = [
                                node._identifiant,
                                tmp
                            ]
                        }
                    }
                    return tmp;
                };

                let tableau = [];
                ends.forEach((value, index, array) => {
                    let test = returnIdentifiants(value, blocks);

                    let tmp = returnTable(value, returnIdentifiants(value._parentIdentifiant, blocks));
                    /*while(test._parentIdentifiant === "null"){
                        if(returnIdentifiants(test._parentIdentifiant, blocks)._nextIdentifiant === test._identifiant){
                            tmp.unshift(test._identifiant);
                        }else{
                            tmp = [
                                ends[0]._identifiant,
                                tmp
                            ]
                        }
                    }*/
                    tableau.push(tmp);
                });
                console.log(tableau);
            });
        </script>
    </body>
</html>